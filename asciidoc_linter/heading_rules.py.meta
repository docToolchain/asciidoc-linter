Updated implementation with fixed format checking